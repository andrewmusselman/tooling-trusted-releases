{% extends "layouts/base.html" %}

{% block title %}
  Resolve vote for {{ release.short_display_name }} ~ ATR
{% endblock title %}

{% block description %}
  Resolve the vote for the {{ release.project.display_name }} {{ release.version }} release candidate.
{% endblock description %}

{% block content %}
  <p class="d-flex justify-content-between align-items-center">
    <a href="{{ as_url(routes.root.index) }}" class="atr-back-link">← Back to Select a release</a>
    <span>
      <span class="atr-phase-symbol-other">①</span>
      <span class="atr-phase-arrow">→</span>
      <strong class="atr-phase-two atr-phase-symbol">②</strong>
      <span class="atr-phase-two atr-phase-label">VOTE</span>
      <span class="atr-phase-arrow">→</span>
      <span class="atr-phase-symbol-other">③</span>
    </span>
  </p>

  <h1>
    Resolve vote for <strong>{{ release.project.short_display_name }}</strong> <em>{{ release.version }}</em>
  </h1>
  <p>
    Resolve the vote for the <strong>release candidate</strong> for {{ release.project.display_name }} {{ release.version }}. If you resolve a vote as passed, the release candidate will be promoted to the next stage, making it a release preview. If you resolve a vote as failed, the release candidate will be returned to the draft stage.
  </p>

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Release information</h5>
    </div>
    <div class="card-body pb-0 mb-1">
      <div class="row">
        <div class="col-md-6">
          <p>
            <strong>Project:</strong>
            <a href="{{ as_url(routes.projects.view, name=release.project.name) }}">{{ release.project.display_name }}</a>
          </p>
          <p>
            <strong>Label:</strong> {{ release.name }}
          </p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>Created:</strong> {{ format_datetime(release.created) }}
          </p>
          {% if release.vote_started %}
            <p>
              <strong>Vote Started:</strong> {{ format_datetime(release.vote_started) }}
            </p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="card-body">
      <a href="{{ as_url(routes.candidate.view, project_name=release.project.name, version_name=release.version) }}"
         class="btn btn-primary">View files</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Vote email details</h5>
    </div>
    <div class="card-body">
      <div class="p-3 border rounded bg-white mb-3">
        {% if vote_task %}
          {% if vote_task.status.value == "completed" %}
            <p class="mb-0 text-success fw-semibold">
              <i class="bi bi-check-circle me-1"></i> Vote email sent: {{ format_datetime(vote_task.completed) }}
            </p>
            {% if task_mid %}
              <p class="mt-2 mb-0 text-muted ps-4">
                Message-ID: <code class="user-select-all">{{ task_mid }}</code>
              </p>
            {% endif %}
          {% elif vote_task.status.value == "failed" %}
            <p class="mb-1 text-danger fw-semibold">
              <i class="bi bi-x-circle me-1"></i> Vote email failed: {{ format_datetime(vote_task.completed) }}
            </p>
            <div class="alert alert-danger mt-2 mb-0 p-2" role="alert">
              <p class="mb-0 p-2 text-danger">{{ vote_task.error }}</p>
            </div>
          {% else %}
            <p class="mb-0 text-warning fw-semibold">
              <i class="bi bi-hourglass-split me-1"></i> Vote email task status: {{ vote_task.status.value.upper() }}
              {% if vote_task.started %}
                (Started: {{ format_datetime(vote_task.started) }})
              {% else %}
                (Added: {{ format_datetime(vote_task.added) }})
              {% endif %}
            </p>
          {% endif %}
          {% if archive_url %}
            <p class="mt-2 mb-0 text-muted ps-4">
              <a href="{{ archive_url }}">View vote email in the archive <i class="bi bi-box-arrow-up-right ms-1"></i></a>
            </p>
          {% elif task_mid %}
            <p class="mt-2 mb-0 text-muted ps-4">Could not retrieve archive URL for this message.</p>
          {% endif %}
        {% else %}
          <p class="mb-0 text-muted">
            <i class="bi bi-question-circle me-1"></i> Vote email: No vote initiation task found for this release.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Resolve vote</h5>
    </div>
    <div class="card-body">
      <form method="post"
            action="{{ as_url(routes.resolve.selected_post, project_name=release.project.name, version_name=release.version) }}"
            class="atr-canary py-4 px-5"
            novalidate>
        <input type="hidden" name="candidate_name" value="{{ release.name }}" />
        {{ form.csrf_token }}

        <div class="mb-3 pb-3 row border-bottom">
          <label class="col-sm-3 col-form-label text-sm-end fw-semibold">{{ form.vote_result.label.text }}:</label>
          <div class="col-sm-9 pt-2">
            {% for subfield in form.vote_result %}
              <div class="form-check form-check-inline">
                {{ subfield(class="form-check-input" + (" is-invalid" if form.vote_result.errors else "") , id=subfield.id ~ "_" ~ loop.index) }}
                <label class="form-check-label" for="{{ subfield.id }}_{{ loop.index }}">{{ subfield.label.text }}</label>
              </div>
            {% endfor %}
            {% if form.vote_result.errors %}
              <div class="invalid-feedback d-block">{{ form.vote_result.errors[0] }}</div>
            {% endif %}
          </div>
        </div>

        <div class="row">
          <div class="col-sm-9 offset-sm-3">{{ form.submit(class_="btn btn-primary mt-3") }}</div>
        </div>
      </form>
    </div>
  </div>
{% endblock content %}
