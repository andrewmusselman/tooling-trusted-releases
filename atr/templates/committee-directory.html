{% extends "layouts/base.html" %}

{% block title %}
  Committee directory ~ ATR
{% endblock title %}

{% block description %}
  List of all ASF committees and their associated projects.
{% endblock description %}

{% block stylesheets %}
  {{ super() }}
  <style>
      .page-logo {
          max-height: 100%;
          width: auto;
          object-fit: contain;
      }

      .page-logo-container {
          height: 48px;
          width: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
      }
  </style>
{% endblock stylesheets %}

{% block content %}
  <h1>Committee directory</h1>
  <p>Current ASF committees and their projects:</p>

  <div class="mb-3">
    <input type="text"
           id="project-filter"
           aria-label="Project name filter"
           class="form-control d-inline-block w-auto" />
    <button type="button" class="btn btn-primary" id="filter-button">Filter all</button>
    {% if current_user %}
      <button type="button"
              class="btn btn-secondary ms-2"
              id="filter-participant-button"
              aria-pressed="false"
              data-showing="participant">
        {% if current_user %}
          Show all committees
        {% else %}
          Show my committees
        {% endif %}
      </button>
    {% endif %}
  </div>

  <div class="mb-3">
    <p>
      Total count: <span id="committee-count">{{ committees|length }}</span>
    </p>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for committee in committees %}
      {% set is_part = false %}
      {% if current_user and committee %}
        {% if (current_user.uid in committee.committee_members) or
          (current_user.uid in committee.committers) or
          (current_user.uid in committee.release_managers) %}
          {% set is_part = true %}
        {% endif %}
      {% endif %}
      <div class="col">
        <div class="card h-100 shadow-sm atr-cursor-pointer page-project-card"
             data-project-url="{{ as_url(routes.committees.view, name=committee.name) }}"
             data-is-participant="{{ 'true' if is_part else 'false' }}">
          <div class="card-body">
            <div class="row mb-3 align-items-center">
              <div class="col">
                <h3 class="card-title fs-4 mb-0">{{ committee.display_name }}</h3>
              </div>
              <div class="col-5 col-lg-4 text-center">
                <div class="page-logo-container">
                  {% if (committee.name == "incubator") or committee.name.startswith("incubator-") %}
                    <img src="https://www.apache.org/logos/res/incubator/default.png"
                         alt=""
                         class="page-logo"
                         onerror="this.style.display='none';" />
                  {% else %}
                    <img src="https://www.apache.org/logos/res/{{ committee.name }}/default.png"
                         alt=""
                         class="page-logo"
                         onerror="this.style.display='none';" />
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col">
                <div class="card h-100 bg-light border-0">
                  <div class="card-body p-2 d-flex flex-column justify-content-between text-center">
                    <small class="text-secondary">Projects</small>
                    <span class="fs-4 fw-medium mt-2">{{ committee.projects|length }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock content %}

{% block javascripts %}
  {{ super() }}
  <script>
      let allCommitteeCards = [];

      function filterCommitteesByText() {
          const projectFilter = document.getElementById("project-filter").value;
          const cards = allCommitteeCards;
          let visibleCount = 0;

          if (participantButton && participantButton.dataset.showing === "participant") {
              participantButton.dataset.showing = "all";
              participantButton.textContent = "Show my committees";
              participantButton.setAttribute("aria-pressed", "false");
          }

          for (let card of cards) {
              const nameElement = card.querySelector(".card-title");
              const name = nameElement.textContent.trim();
              if (!projectFilter) {
                  card.parentElement.hidden = false;
                  visibleCount++;
              } else {
                  let regex;
                  try {
                      regex = new RegExp(projectFilter, "i");
                  } catch (e) {
                      const escapedFilter = projectFilter.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                      regex = new RegExp(escapedFilter, "i");
                  }
                  card.parentElement.hidden = !name.match(regex);
                  if (!card.parentElement.hidden) {
                      visibleCount++;
                  }
              }
          }
          document.getElementById("committee-count").textContent = visibleCount;
      }

      // Add event listeners
      document.getElementById("filter-button").addEventListener("click", filterCommitteesByText);
      document.getElementById("project-filter").addEventListener("keydown", function(event) {
          if (event.key === "Enter") {
              filterCommitteesByText();
              event.preventDefault();
          }
      });

      const participantButton = document.getElementById("filter-participant-button");
      if (participantButton) {
          participantButton.addEventListener("click", function() {
              const showing = this.dataset.showing;
              const cards = allCommitteeCards;
              let visibleCount = 0;

              if (showing === "all") {
                  cards.forEach(card => {
                      const isParticipant = card.dataset.isParticipant === "true";
                      card.parentElement.hidden = !isParticipant;
                      if (!card.parentElement.hidden) {
                          visibleCount++;
                      }
                  });
                  this.textContent = "Show all committees";
                  this.dataset.showing = "participant";
                  this.setAttribute("aria-pressed", "true");
              } else {
                  cards.forEach(card => {
                      card.parentElement.hidden = false;
                      visibleCount++;
                  });
                  this.textContent = "Show my committees";
                  this.dataset.showing = "all";
                  this.setAttribute("aria-pressed", "false");
              }
              document.getElementById("project-filter").value = "";
              document.getElementById("committee-count").textContent = visibleCount;
          });
      }

      document.addEventListener("DOMContentLoaded", function() {
          allCommitteeCards = Array.from(document.querySelectorAll(".page-project-card"));
          const cards = allCommitteeCards;
          const committeeCountSpan = document.getElementById("committee-count");
          let initialVisibleCount = 0;
          const initialShowingMode = participantButton ? participantButton.dataset.showing : "all";

          if (participantButton) {
              if (initialShowingMode === "participant") {
                  participantButton.setAttribute("aria-pressed", "true");
              } else {
                  participantButton.setAttribute("aria-pressed", "false");
              }
          }

          if (initialShowingMode === "participant") {
              cards.forEach(card => {
                  const isParticipant = card.dataset.isParticipant === "true";
                  card.parentElement.hidden = !isParticipant;
                  if (!card.parentElement.hidden) {
                      initialVisibleCount++;
                  }
              });
          } else {
              cards.forEach(card => {
                  card.parentElement.hidden = false;
                  initialVisibleCount++;
              });
          }
          committeeCountSpan.textContent = initialVisibleCount;
      });

      document.querySelectorAll(".page-project-card").forEach(function(card) {
          card.addEventListener("click", function() {
              window.location.href = this.getAttribute("data-project-url");
          });
      });
  </script>
{% endblock javascripts %}
