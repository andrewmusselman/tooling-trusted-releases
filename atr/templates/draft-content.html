{% extends "layouts/base.html" %}

{% block title %}
  {{ release.project.display_name }} {{ version_name }} ~ ATR
{% endblock title %}

{% block description %}
  Overview and management page for the {{ release.project.display_name }} {{ version_name }} candidate draft.
{% endblock description %}

{% import 'macros/dialog.html' as dialog %}

{% block stylesheets %}
  {{ super() }}
  <style>
      .page-table-striped-odd {
          background-color: #eeeeee;
      }

      .page-icon-cell {
          width: 2em;
          text-align: center;
      }

      table tr {
          border-bottom: none;
      }
  </style>
{% endblock stylesheets %}

{% block content %}
  <p class="d-flex justify-content-between align-items-center">
    <a href="{{ as_url(routes.root.index) }}" class="atr-back-link">← Back to Select a release</a>
    <span>
      <strong class="atr-phase-one atr-phase-symbol">①</strong>
      <span class="atr-phase-one atr-phase-label">COMPOSE</span>
      <span class="atr-phase-arrow">→</span>
      <span class="atr-phase-symbol-other">②</span>
      <span class="atr-phase-arrow">→</span>
      <span class="atr-phase-symbol-other">③</span>
    </span>
  </p>

  <h1>
    Compose <strong>{{ release.project.short_display_name }}</strong> <em>{{ release.version }}</em>
  </h1>
  <p>
    Manage the <strong>candidate draft</strong> for {{ release.project.display_name }} {{ version_name }}. Add files, review checks, and promote when ready.
  </p>

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Release information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p>
            <strong>Project:</strong>
            <a href="{{ as_url(routes.projects.view, name=release.project.name) }}">{{ release.project.display_name }}</a>
          </p>
          <p>
            <strong>Label:</strong> {{ release.name }}
          </p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>Created:</strong> {{ format_datetime(release.created) }}
          </p>
          {% if revision_time %}
            <p>
              <strong>Revision:</strong>
              <a href="{{ as_url(routes.draft.revisions, project_name=project_name, version_name=version_name) }}#{{ revision_name_from_link }}">
                {{ format_datetime(revision_time) }}
              </a>
              {% if revision_editor %}by {{ revision_editor }}{% endif %}
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Draft actions</h5>
    </div>
    <div class="card-body d-flex flex-wrap gap-2">
      <a href="{{ as_url(routes.draft.add_files, project_name=release.project.name, version_name=release.version) }}"
         title="Upload files to this draft"
         class="btn btn-primary"><i class="fas fa-upload me-1"></i> Upload files</a>
      <a href="{{ as_url(routes.draft.revisions, project_name=release.project.name, version_name=release.version) }}"
         title="View revision history"
         class="btn btn-secondary"><i class="fas fa-history me-1"></i> Revisions</a>
      <a href="{{ as_url(routes.draft.vote_start, project_name=release.project.name, version=release.version, revision=release.revision) }}"
         title="Start a vote on this draft"
         class="btn btn-success"><i class="fas fa-check-circle me-1"></i> Start vote</a>
      <button class="btn btn-danger"
              title="Delete this entire draft"
              data-bs-toggle="modal"
              data-bs-target="#delete-{{ release.name|slugify }}">
        <i class="fas fa-trash me-1"></i> Delete draft
      </button>
    </div>
  </div>
  {{ dialog.delete_modal_with_confirm(release.name|slugify, "Delete candidate draft", "candidate draft", as_url(routes.draft.delete) , delete_form, "candidate_draft_name") }}

  {% if ongoing_tasks_count > 0 %}
    <div class="alert alert-warning" role="alert">
      <i class="fa-solid fa-triangle-exclamation me-2"></i>
      There {{ 'is' if ongoing_tasks_count == 1 else 'are' }} currently <strong>{{ ongoing_tasks_count }}</strong> background verification {{ 'task' if ongoing_tasks_count == 1 else 'tasks' }} running for the latest revision. Results shown below may be incomplete or outdated until the tasks finish. Refresh the page to see updates.
    </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Files in this revision</h5>
    </div>
    <div class="card-body">
      {% if paths|length > 0 %}
        <div class="table-responsive">
          {# This table uses pairs of rows, so it must be manually striped #}
          <table class="table table-hover align-middle table-sm mb-0 border">
            <tbody>
              {% for path in paths %}
                {% set has_errors = errors[path]|length > 0 %}
                {% set has_warnings = warnings[path]|length > 0 %}
                {% set row_id = path|string|slugify %}

                {# Manual striping for pairs of rows #}
                {% set row_bg_class = "" %}
                {% if loop.index is odd %}
                  {% set row_bg_class = "page-table-striped-odd" %}
                {% endif %}

                {% set path_style_class = "" %}
                {% if has_errors %}
                  {% set path_style_class = "text-danger" %}
                {% elif has_warnings %}
                  {% set path_style_class = "text-warning" %}
                {% endif %}

                <tr class="{{ row_bg_class }}">
                  <td class="text-center px-1 py-2 page-icon-cell">
                    {% set icon_class = "text-success" %}
                    {% if has_errors %}
                      {% set icon_class = "text-danger" %}
                    {% elif has_warnings %}
                      {% set icon_class = "text-warning" %}
                    {% endif %}

                    {% if path in artifacts %}
                      <i class="fas fa-box-archive {{ icon_class }}"
                         title="Artifact"
                         aria-label="Artifact"></i>
                    {% elif path in metadata %}
                      <i class="fas fa-file-alt {{ icon_class }}"
                         title="Metadata"
                         aria-label="Metadata"></i>
                    {% else %}
                      <i class="fas fa-file {{ icon_class }}" title="File" aria-label="File"></i>
                    {% endif %}
                  </td>
                  <td class="py-2">
                    <a href="{{ as_url(routes.draft.view_path, project_name=project_name, version_name=version_name, file_path=path) }}"
                       title="View file {{ path }}"
                       class="text-decoration-none text-reset">
                      {% if has_errors or has_warnings %}
                        <strong class="{{ path_style_class }}"><code>{{ path }}</code></strong>
                      {% else %}
                        <code>{{ path }}</code>
                      {% endif %}
                    </a>
                  </td>
                  <td class="text-end text-nowrap py-2">
                    <div class="d-flex justify-content-end align-items-center gap-2">
                      {% if has_errors %}
                        <a href="{{ as_url(routes.draft.evaluate_path, project_name=project_name, version_name=version_name, rel_path=path) }}"
                           class="btn btn-sm btn-outline-danger"><i class="fas fa-exclamation-triangle me-1"></i> Show {{ errors[path]|length }} {{ "error" if errors[path]|length == 1 else "errors" }}</a>
                      {% elif has_warnings %}
                        <a href="{{ as_url(routes.draft.evaluate_path, project_name=project_name, version_name=version_name, rel_path=path) }}"
                           class="btn btn-sm btn-outline-warning">Show {{ warnings[path]|length }} {{ "warning" if warnings[path]|length == 1 else "warnings" }}</a>
                      {% elif successes[path] %}
                        <a href="{{ as_url(routes.draft.evaluate_path, project_name=project_name, version_name=version_name, rel_path=path) }}"
                           class="btn btn-sm btn-outline-success">Show report</a>
                      {% else %}
                        <span class="btn btn-sm btn-outline-secondary disabled">No checks run</span>
                      {% endif %}

                      <button class="btn btn-sm btn-outline-secondary"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#actions-{{ row_id }}"
                              aria-expanded="false"
                              aria-controls="actions-{{ row_id }}"
                              title="Show more actions for {{ path }}"
                              onclick="this.innerHTML = (this.innerHTML.trim() === 'More') ? 'Less' : 'More';">
                        More
                      </button>
                    </div>
                  </td>
                </tr>

                <tr class="{{ row_bg_class }}">
                  <td colspan="3" class="p-0 border-0">
                    <div class="collapse px-3 py-2" id="actions-{{ row_id }}">
                      <div class="d-flex justify-content-end">
                        <div class="btn-group btn-group-sm"
                             role="group"
                             aria-label="More file actions for {{ path }}">
                          <a href="{{ as_url(routes.download.phase, phase='candidate-draft', project=release.project.name, version=release.version, path=path) }}"
                             title="Download file {{ path }}"
                             class="btn btn-outline-secondary">Download</a>
                          <a href="{{ as_url(routes.draft.tools, project_name=project_name, version_name=version_name, file_path=path) }}"
                             title="Tools for file {{ path }}"
                             class="btn btn-outline-secondary">Tools</a>
                          <button class="btn btn-outline-danger"
                                  data-bs-toggle="modal"
                                  data-bs-target="#delete-{{ row_id }}"
                                  title="Delete file {{ path }}">Delete</button>
                        </div>
                        {{ dialog.delete_modal(row_id, "Delete file", "file, and any associated metadata files", as_url(routes.draft.delete_file, project_name=project_name, version_name=version_name) , delete_file_form, "file_path") }}
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">This draft does not have any files yet.</div>
      {% endif %}
    </div>
  </div>

{% endblock content %}

{% block javascripts %}
  {{ super() }}
  <script>
      init();
  </script>
{% endblock javascripts %}
