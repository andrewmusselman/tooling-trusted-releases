{% extends "layouts/base.html" %}

{% block title %}
  Finish {{ release.project.display_name }} {{ release.version }} ~ ATR
{% endblock title %}

{% block description %}
  Finish {{ release.project.display_name }} {{ release.version }} as a release preview.
{% endblock description %}

{% block stylesheets %}
  {{ super() }}
  <style>
      .page-file-select-text {
          vertical-align: middle;
          margin-left: 8px;
      }

      .page-table-button-cell {
          width: 1%;
          white-space: nowrap;
          vertical-align: middle;
      }

      .page-table-path-cell {
          vertical-align: middle;
      }

      .page-item-selected td {
          background-color: #e9ecef;
          font-weight: 500;
      }
  </style>
{% endblock stylesheets %}

{% block content %}
  <p class="d-flex justify-content-between align-items-center">
    <a href="{{ as_url(routes.root.index) }}" class="atr-back-link">← Back to Select a release</a>
    <span>
      <span class="atr-phase-symbol-other">①</span>
      <span class="atr-phase-arrow">→</span>
      <strong class="atr-phase-symbol-other">②</strong>
      <span class="atr-phase-arrow">→</span>
      <strong class="atr-phase-three atr-phase-symbol">③</strong>
      <span class="atr-phase-three atr-phase-label">FINISH</span>
    </span>
  </p>

  <h1>
    Finish <strong>{{ release.project.short_display_name }}</strong> <em>{{ release.version }}</em>
  </h1>

  <div id="{{ release.name }}" class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h3 class="card-title mb-0">About this release preview</h3>
    </div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-3 pb-3 mb-3 border-bottom text-secondary fs-6">
        <span class="page-preview-meta-item">Revision: {{ release.latest_revision_number }}</span>
        <span class="page-preview-meta-item">Created: {{ release.created.strftime("%Y-%m-%d %H:%M:%S UTC") }}</span>
      </div>
      <div>
        <a title="Download all files"
           href="{{ as_url(routes.download.all_selected, project_name=release.project.name, version_name=release.version) }}"
           class="btn btn-primary me-2">
          <i class="bi bi-download"></i>
          Download all files
        </a>
        <a title="Show files for {{ release.name }}"
           href="{{ as_url(routes.preview.view, project_name=release.project.name, version_name=release.version) }}"
           class="btn btn-secondary me-2">
          <i class="bi bi-archive"></i>
          Show files
        </a>
        <a title="Show revisions for {{ release.name }}"
           href="{{ as_url(routes.revisions.selected, project_name=release.project.name, version_name=release.version) }}"
           class="btn btn-secondary me-2">
          <i class="bi bi-clock-history"></i>
          Show revisions
        </a>
        <a title="Announce and distribute {{ release.name }}"
           href="{{ as_url(routes.announce.selected, project_name=release.project.name, version_name=release.version) }}"
           class="btn btn-success">
          <i class="bi bi-check-circle"></i>
          Announce and distribute
        </a>
      </div>
    </div>
  </div>

  <p>
    During this phase you should distribute release artifacts to your package distribution networks such as Maven Central, PyPI, or Docker Hub.
  </p>

  <div class="alert alert-warning mb-4" role="alert">
    <p class="fw-semibold mb-1">TODO</p>
    <p class="mb-1">
      We plan to add tools to help release managers to distribute release artifacts on distribution networks. Currently you must do this manually. Other planned enhancements include removing "RC" tags from filenames (not yet implemented) and improving the interface of the file movement feature below.
    </p>
  </div>

  {% if can_move %}
    <h2>Move a file to a different directory</h2>
    <form class="atr-canary">
      <div class="row">
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h3 class="mb-0">Select a file to move</h3>
            </div>
            <div class="card-body">
              <input type="text"
                     id="file-filter"
                     class="form-control mb-2"
                     placeholder="Search for a file to move..." />
              <table class="table table-sm table-striped border mt-3">
                <tbody id="file-list-table-body">
                </tbody>
              </table>
              <div id="file-list-more-info" class="text-muted small mt-1"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h3 class="mb-0">
                <span id="selected-file-name-title">Select a destination for the file</span>
              </h3>
            </div>
            <div class="card-body">
              <input type="text"
                     id="dir-filter-input"
                     class="form-control mb-2"
                     placeholder="Search for a directory to move to..." />
              <table class="table table-sm table-striped border mt-3">
                <tbody id="dir-list-table-body">
                </tbody>
              </table>
              <div id="dir-list-more-info" class="text-muted small mt-1"></div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="mb-3">
          <label for="maxFilesInput" class="form-label">Items to show per list:</label>
          <input type="number"
                 class="form-control form-control-sm w-25"
                 id="max-files-input"
                 value="5"
                 min="1" />
        </div>
        <div id="current-move-selection-info" class="text-muted">Please select a file and a destination.</div>
        <button type="button" id="confirm-move-button" class="btn btn-success mt-2">Move file to selected directory</button>
      </div>
    </form>
  {% else %}
    <div class="alert alert-info" role="alert">
      File moving is disabled as all files are currently in the same directory or the revision is empty.
    </div>
  {% endif %}
{% endblock content %}

{% block javascripts %}
  {{ super() }}
  {# If we don't turn the linter off, it breaks the Jinja2 variables #}
  {# djlint:off #}
  <script id="file-data" type="application/json">
      {{ source_files | tojson | safe }}
</script>
  <script id="dir-data" type="application/json">
      {{ target_dirs | tojson | safe }}
</script>
  {# djlint:on #}
  <script id="main-script-data" data-csrf-token="{{ form.csrf_token.current_token }}">
      document.addEventListener("DOMContentLoaded", function() {
          const fileFilterInput = document.getElementById("file-filter");
          const fileListTableBody = document.getElementById("file-list-table-body");

          let originalFilePaths = [];
          let allTargetDirs = [];

          try {
              const fileDataElement = document.getElementById("file-data");
              if (fileDataElement) {
                  originalFilePaths = JSON.parse(fileDataElement.textContent || "[]");
              }
              const dirDataElement = document.getElementById("dir-data");
              if (dirDataElement) {
                  allTargetDirs = JSON.parse(dirDataElement.textContent || "[]");
              }
          } catch (e) {
              console.error("Error parsing JSON data:", e);
              originalFilePaths = [];
              allTargetDirs = [];
          }

          let maxFilesToShow = 5;
          const maxFilesInput = document.getElementById("max-files-input");
          if (maxFilesInput) {
              maxFilesToShow = parseInt(maxFilesInput.value, 10);
              maxFilesInput.addEventListener("change", function(event) {
                  const newValue = parseInt(event.target.value, 10);
                  if (newValue >= 1) {
                      maxFilesToShow = newValue;
                      const currentFileFilter = fileFilterInput.value.toLowerCase();
                      const currentDirFilter = dirFilterInput.value.toLowerCase();
                      renderFilesTable(originalFilePaths.filter(fp => String(fp || "").toLowerCase().includes(currentFileFilter)));
                      renderDirsTable(allTargetDirs.filter(dirP => String(dirP || "").toLowerCase().includes(currentDirFilter)));
                  } else {
                      event.target.value = maxFilesToShow;
                  }
              });
          }

          let currentlySelectedFilePath = null;
          let currentlyChosenDirectoryPath = null;

          const selectedFileNameTitleElement = document.getElementById("selected-file-name-title");
          const dirFilterInput = document.getElementById("dir-filter-input");
          const dirListTableBody = document.getElementById("dir-list-table-body");
          const confirmMoveButton = document.getElementById("confirm-move-button");
          const currentMoveSelectionInfoElement = document.getElementById("current-move-selection-info");

          function getParentPath(filePathString) {
              if (!filePathString || typeof filePathString !== "string") return ".";
              const lastSlash = filePathString.lastIndexOf("/");
              if (lastSlash === -1) return ".";
              if (lastSlash === 0) return "/";
              return filePathString.substring(0, lastSlash);
          }

          function updateMoveSelectionInfo() {
              if (!currentMoveSelectionInfoElement) return;

              if (selectedFileNameTitleElement) {
                  if (currentlySelectedFilePath) {
                      selectedFileNameTitleElement.textContent = `Select a destination for ${currentlySelectedFilePath}`;
                  } else {
                      selectedFileNameTitleElement.textContent = "Select a destination for the file";
                  }
              }

              if ((!currentlySelectedFilePath) && currentlyChosenDirectoryPath) {
                  currentMoveSelectionInfoElement.innerHTML = `Selected destination: <strong>${currentlyChosenDirectoryPath}</strong>. Please select a file to move.`;
                  confirmMoveButton.disabled = true;
              } else if (currentlySelectedFilePath && (!currentlyChosenDirectoryPath)) {
                  currentMoveSelectionInfoElement.innerHTML = `Moving <strong>${currentlySelectedFilePath}</strong> to (select destination).`;
                  confirmMoveButton.disabled = true;
              } else if (currentlySelectedFilePath && currentlyChosenDirectoryPath) {
                  currentMoveSelectionInfoElement.innerHTML = `Move <strong>${currentlySelectedFilePath}</strong> to <strong>${currentlyChosenDirectoryPath}</strong>`;
                  confirmMoveButton.disabled = false;
              } else {
                  currentMoveSelectionInfoElement.textContent = "Please select a file and a destination.";
                  confirmMoveButton.disabled = true;
              }
          }

          function renderList(tbodyElement, items, config) {
              tbodyElement.innerHTML = "";

              items.slice(0, maxFilesToShow).forEach(item => {
                  const row = tbodyElement.insertRow();
                  const itemPathString = config.itemType === "dir" ? String(item || ".") : String(item);

                  const buttonCell = row.insertCell();
                  buttonCell.classList.add("page-table-button-cell");
                  const pathCell = row.insertCell();
                  pathCell.classList.add("page-table-path-cell");

                  const button = document.createElement("button");
                  button.type = "button";
                  button.className = `btn btn-sm m-1 ${config.buttonClassBase} ${config.buttonClassOutline}`;
                  button.dataset[config.itemType === "file" ? "filePath" : "dirPath"] = itemPathString;

                  if (itemPathString === config.selectedItem) {
                      row.classList.add("page-item-selected");
                      button.textContent = config.buttonTextSelected;
                      button.classList.remove(config.buttonClassOutline);
                      button.classList.add(config.buttonClassActive);
                  } else {
                      button.textContent = config.buttonTextDefault;
                  }

                  if (config.disableCondition(itemPathString, currentlySelectedFilePath, currentlyChosenDirectoryPath, getParentPath)) {
                      button.disabled = true;
                  }

                  button.addEventListener("click", config.eventHandler);

                  const span = document.createElement("span");
                  span.className = "page-file-select-text";
                  span.textContent = itemPathString;

                  buttonCell.appendChild(button);
                  pathCell.appendChild(span);
              });

              const moreInfoElement = document.getElementById(config.moreInfoId);
              if (moreInfoElement) {
                  if (items.length > maxFilesToShow) {
                      moreInfoElement.textContent = `${items.length - maxFilesToShow} more available (filter to browse)...`;
                      moreInfoElement.style.display = "block";
                  } else {
                      moreInfoElement.textContent = "";
                      moreInfoElement.style.display = "none";
                  }
              }
          }

          function renderDirsTable(dirsToShow) {
              const dirsConfig = {
                  itemType: "dir",
                  selectedItem: currentlyChosenDirectoryPath,
                  buttonClassBase: "choose-dir-btn",
                  buttonClassOutline: "btn-outline-secondary",
                  buttonClassActive: "btn-secondary",
                  buttonTextSelected: "Chosen",
                  buttonTextDefault: "Choose",
                  eventHandler: handleDirChooseClick,
                  moreInfoId: "dir-list-more-info",
                  disableCondition: (itemPath, selectedFile, _chosenDir, getParent) => selectedFile && (getParent(selectedFile) === itemPath)
              };
              renderList(dirListTableBody, dirsToShow, dirsConfig);
          }

          function handleDirChooseClick(event) {
              currentlyChosenDirectoryPath = event.target.dataset.dirPath;
              const filterText = dirFilterInput.value.toLowerCase();
              const filteredDirs = allTargetDirs.filter(dirP => String(dirP || "").toLowerCase().includes(filterText));
              renderDirsTable(filteredDirs);

              const fileFilterText = fileFilterInput.value.toLowerCase();
              const filteredFilePaths = originalFilePaths.filter(fp => String(fp || "").toLowerCase().includes(fileFilterText));
              renderFilesTable(filteredFilePaths);

              updateMoveSelectionInfo();
          }

          function handleFileSelectButtonClick(event) {
              const newlySelectedFilePath = event.target.dataset.filePath;

              if (currentlyChosenDirectoryPath) {
                  const parentOfNewFile = getParentPath(newlySelectedFilePath);
                  if (parentOfNewFile === currentlyChosenDirectoryPath) {
                      currentlyChosenDirectoryPath = null;
                  }
              }

              currentlySelectedFilePath = newlySelectedFilePath;

              const fileFilterText = fileFilterInput.value.toLowerCase();
              const filteredFilePaths = originalFilePaths.filter(fp => String(fp || "").toLowerCase().includes(fileFilterText));
              renderFilesTable(filteredFilePaths);

              const dirFilterText = dirFilterInput.value.toLowerCase();
              const filteredDirs = allTargetDirs.filter(dirP => String(dirP || "").toLowerCase().includes(dirFilterText));
              renderDirsTable(filteredDirs);

              updateMoveSelectionInfo();
          }

          function renderFilesTable(pathsToShow) {
              const filesConfig = {
                  itemType: "file",
                  selectedItem: currentlySelectedFilePath,
                  buttonClassBase: "select-file-btn",
                  buttonClassOutline: "btn-outline-primary",
                  buttonClassActive: "btn-primary",
                  buttonTextSelected: "Selected",
                  buttonTextDefault: "Select",
                  eventHandler: handleFileSelectButtonClick,
                  moreInfoId: "file-list-more-info",
                  disableCondition: (itemPath, _selectedFile, chosenDir, getParent) => chosenDir && (getParent(itemPath) === chosenDir)
              };
              renderList(fileListTableBody, pathsToShow, filesConfig);
          }

          if (dirFilterInput) {
              dirFilterInput.addEventListener("input", function() {
                  const filterText = dirFilterInput.value.toLowerCase();
                  const filteredDirs = allTargetDirs.filter(dirPath => {
                      return String(dirPath || "").toLowerCase().includes(filterText);
                  });
                  renderDirsTable(filteredDirs);
              });
          }

          fileFilterInput.addEventListener("input", function() {
              const filterText = fileFilterInput.value.toLowerCase();
              const filteredPaths = originalFilePaths.filter(filePath => {
                  return String(filePath || "").toLowerCase().includes(filterText);
              });
              renderFilesTable(filteredPaths);
          });

          renderFilesTable(originalFilePaths);
          renderDirsTable(allTargetDirs);

          if (confirmMoveButton) {
              confirmMoveButton.addEventListener("click", function() {
                  if (currentlySelectedFilePath && currentlyChosenDirectoryPath) {
                      const formData = new FormData();
                      const mainScriptElement = document.getElementById("main-script-data");
                      const csrfToken = mainScriptElement.dataset.csrfToken;
                      formData.append("csrf_token", csrfToken);
                      formData.append("source_file", currentlySelectedFilePath);
                      formData.append("target_directory", currentlyChosenDirectoryPath);
                      fetch(window.location.pathname, {
                              method: "POST",
                              body: formData,
                          })
                          .then(response => {
                              if (response.ok) {
                                  window.location.reload();
                              } else {
                                  alert("An error occurred while moving the file.");
                              }
                          })
                          .catch(() => {
                              alert("A network error occurred.");
                          });
                  } else {
                      alert("Please select both a file to move and a destination directory.");
                  }
              });
          }

          updateMoveSelectionInfo();
      });
  </script>
{% endblock javascripts %}
