{% extends "layouts/base.html" %}

{% block title %}
  Upload KEYS file ~ ATR
{% endblock title %}

{% block description %}
  Upload a KEYS file containing multiple GPG public keys.
{% endblock description %}

{% block content %}
  <h1>Upload KEYS file</h1>
  <p>Upload a KEYS file containing multiple GPG public keys.</p>

  {% if form.errors %}
    <h2 class="text-danger">Form errors</h2>
    <div class="mt-3 mb-3">
      {% for field, errors in form.errors.items() %}
        {% for error in errors %}<p class="text-danger mb-1">{{ field }}: {{ error }}</p>{% endfor %}
      {% endfor %}
    </div>
  {% endif %}

  {% if results %}
    <h2>KEYS processing results</h2>
    <p>The following keys were found in your KEYS file:</p>

    {% for key_info in results %}
      {% if key_info.status == "success" %}
        {% set bg_class = "bg-light" %}
      {% else %}
        {% set bg_class = "bg-danger-subtle" %}
      {% endif %}
      <div class="my-3 p-3 rounded {{ bg_class }}">
        <h3 class="mt-0">
          {% if key_info.status == "success" %}
            Success: Added Key
          {% else %}
            Error: Failed to add key
          {% endif %}
        </h3>
        <dl class="row mb-0">
          <dt class="col-sm-3 fw-bold">Key ID</dt>
          <dd class="col-sm-9 mb-2">
            {{ key_info.key_id }}
          </dd>
          <dt class="col-sm-3 fw-bold">Fingerprint</dt>
          <dd class="col-sm-9 mb-2">
            {{ key_info.fingerprint }}
          </dd>
          <dt class="col-sm-3 fw-bold">User ID</dt>
          <dd class="col-sm-9 mb-2">
            {{ key_info.user_id }}
          </dd>
          {% if key_info.status == 'success' %}
            <dt class="col-sm-3 fw-bold">Created</dt>
            <dd class="col-sm-9 mb-2">
              {{ key_info.creation_date }}
            </dd>
            <dt class="col-sm-3 fw-bold">Expires</dt>
            <dd class="col-sm-9 mb-2">
              {{ key_info.expiration_date or 'Never' }}
            </dd>
          {% endif %}
          <dt class="col-sm-3 fw-bold">Status</dt>
          <dd class="col-sm-9 mb-2">
            {{ key_info.message }}
          </dd>
          {% if key_info.status == 'success' and key_info.data %}
            <details>
              <summary>Key Data</summary>
              <pre class="mb-0">{{ key_info.data }}</pre>
            </details>
          {% endif %}
        </dl>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post"
        class="atr-canary py-4 px-5"
        enctype="multipart/form-data">
    {# {{ form.csrf_token }} #}
    {{ form.hidden_tag() if form.hidden_tag }}

    <div class="mb-4">
      <div class="row mb-3 pb-3 border-bottom">
        <div class="col-md-2 text-md-end fw-medium pt-2">{{ form.key.label(class="form-label") }}</div>
        <div class="col-md-9">
          {{ form.key(class="form-control", aria_describedby="keys-help") }}
          <small id="keys-help" class="form-text text-muted mt-2">
            Upload a KEYS file containing multiple PGP public keys. The file should contain keys in ASCII-armored format, starting with "-----BEGIN PGP PUBLIC KEY BLOCK-----".
          </small>
          {% if form.key.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.key.errors %}{{ error }}{% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      {% if user_committees %}
        <div class="row mb-3 pb-3 border-bottom">
          <div class="col-md-2 text-md-end fw-medium pt-2">Associate keys with committee</div>
          <div class="col-md-9">
            <div class="row">
              {% for value, label in form.selected_committees.choices %}
                <div class="col-sm-12 col-md-6 col-lg-4">
                  <div class="form-check mb-2">
                    <input type="checkbox"
                           name="selected_committees"
                           value="{{ value }}"
                           id="committee_{{ loop.index }}"
                           class="form-check-input" />
                    <label for="committee_{{ loop.index }}" class="form-check-label">{{ label }}</label>
                  </div>
                </div>
              {% else %}
                <p class="text-muted fst-italic">No committees available for association.</p>
              {% endfor %}
            </div>
            <div class="mt-2 mb-2">
              <button type="button"
                      id="toggleCommitteesBtn"
                      class="btn btn-sm btn-outline-secondary">Select all</button>
            </div>
            <small class="form-text text-muted mt-2">
              Select the committee with which to associate these keys. You must be a member of the selected committee.
            </small>
            {% if form.selected_committees.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.selected_committees.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="row mb-3 pb-3 border-bottom">
          <div class="col-md-9 offset-md-2">
            <p class="text-danger">You must be a member of at least one committee to add signing keys.</p>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="mt-4 col-md-9 offset-md-2">
      {{ form.submit(class="btn btn-primary") }}
      <a href="{{ as_url(routes.keys.keys) }}"
         class="btn btn-link text-secondary">Cancel</a>
    </div>
  </form>
{% endblock content %}

{% block javascripts %}
  {{ super() }}
  <script>
      document.addEventListener("DOMContentLoaded", () => {
          const btn = document.getElementById("toggleCommitteesBtn");
          const checkboxes = document.querySelectorAll("input[name='selected_committees']");

          if (!btn || checkboxes.length === 0) return;

          function updateButtonText() {
              let allChecked = true;
              checkboxes.forEach(cb => {
                  if (!cb.checked) allChecked = false;
              });
              btn.textContent = allChecked ? "Select none" : "Select all";
          }

          btn.addEventListener("click", () => {
              let allChecked = true;
              checkboxes.forEach(cb => {
                  if (!cb.checked) allChecked = false;
              });
              const shouldCheck = !allChecked;
              checkboxes.forEach(cb => {
                  cb.checked = shouldCheck;
              });
              updateButtonText();
          });

          checkboxes.forEach(cb => {
              cb.addEventListener("change", updateButtonText);
          });

          updateButtonText();
      });
  </script>
{% endblock javascripts %}
